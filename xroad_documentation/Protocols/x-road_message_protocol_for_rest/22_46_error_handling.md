### 4.6 Error handling

In a normal situation the request reaches the provider service and it returns the response back to the consumer
information system. However, the Security Server may encounter technical errors and in these cases it must respond in a
predictable manner. When a technical error occurs, the Security Server MUST use HTTP status codes as defined in
\[[RFC7231](#Ref_RFC7231)\] to communicate it back to the consumer information system.

\[[RFC7231](#Ref_RFC7231)\] defines over 70 HTTP status codes. Most of the developers do not have them memorized so they
have to go to the Internet and look them up. To make it simpler for the developers the X-Road Message Protocol for REST
uses only a small subset of HTTP status codes.

When it is boiled down, there are really 4 categories of errors between the client and the Security Server.

1. Everything worked in the Security Server's perspective but the provider information system returns an error response.
2. The provider information system encounters a technical error and is not able to return a response.
3. The consumer information system sends a request that does not comply with the X-Road Message Protocol for REST.
4. The Security Server encounters a technical error.

We map these categories to the HTTP status codes and response bodies.

1. The status code, response body and HTTP headers are generated by the provider information system and they are
   returned as-is.
2. 500 - The status code, response body and HTTP headers are returned by the Security Server.
3. 400 - Bad Request. The status code, response body and HTTP headers are returned by the Security Server.
4. 500 - Internal Server Error. The status code, response body and HTTP headers are returned by the Security Server.

Using only the HTTP status codes it is impossible to know if the error occurred on X-Road Security Servers or on the
provider service. The `type` field in the response body gives some tools since the X-Road errors start with `Client` (
consumer service), `Server.ClientProxy` (consumer Security Server) or `Server.ServerProxy` (provider Security Server).
To make it easier to distinguish between the errors coming from the X-Road Security Server and the provider service, the
Security Server MUST add an additional HTTP header to the response when the error occurs on the Security Server.
The `X-Road-Error` header is specified in chapter [4.3](#43-use-of-http-headers).

When the error occurs on the Security Server, the Security Server implementation SHOULD respect the `Accept` header
specified by the consumer information system and return the X-Road error response using the suggested content type,
defaulting to `application/json`. Additionally, the Security Server MUST include `Content-Type` header in the response
to indicate the media type of the response.